<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœè½¦åœºæŸ¥è¯¢ - æ™ºèƒ½åœè½¦ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .parking-card {
            transition: all 0.3s ease;
        }
        .parking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .status-available { color: #10b981; }
        .status-busy { color: #f59e0b; }
        .status-full { color: #ef4444; }
        .map-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
        }
        .filter-button {
            transition: all 0.3s ease;
        }
        .filter-button.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold gradient-text">æ™ºèƒ½åœè½¦ç®¡ç†</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 transition-colors">é¦–é¡µ</a>
                    <a href="search.html" class="text-blue-600 font-medium hover:text-blue-800 transition-colors">åœè½¦åœºæŸ¥è¯¢</a>
                    <a href="navigation.html" class="text-gray-600 hover:text-blue-600 transition-colors">å®¤å†…å¯¼èˆª</a>
                    <a href="booking.html" class="text-gray-600 hover:text-blue-600 transition-colors">é¢„çº¦ç®¡ç†</a>
                    <a href="payment.html" class="text-gray-600 hover:text-blue-600 transition-colors">ç¼´è´¹ä¸­å¿ƒ</a>
                    <a href="dashboard-big-screen.html" class="text-gray-600 hover:text-yellow-400 transition-colors" target="_blank">æ•°æ®å¤§å±</a>

                    <!-- é€šçŸ¥é“ƒé“› -->
                    <button onclick="NotificationManager.showNotificationDrawer()" class="relative p-2 text-gray-600 hover:text-blue-600 transition-colors" id="notification-btn" style="display: none;">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden" id="notification-badge">0</span>
                    </button>

                    <!-- ç™»å½•å‰æ˜¾ç¤º -->
                    <a href="login.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors" id="nav-login-btn">ç™»å½•</a>
                    <a href="register.html" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors" id="nav-register-btn">æ³¨å†Œ</a>

                    <!-- ç™»å½•åæ˜¾ç¤º -->
                    <button onclick="AuthManager.logout()" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors hidden" id="nav-logout-btn">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- é€šçŸ¥æŠ½å±‰ -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="NotificationManager.hideNotificationDrawer()"></div>
    <div id="notification-drawer" class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">æ¶ˆæ¯é€šçŸ¥</h2>
            <button onclick="NotificationManager.hideNotificationDrawer()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
            <button onclick="NotificationManager.markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-800">
                å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»
            </button>
        </div>
        <div id="notification-list" class="flex-1 overflow-y-auto" style="max-height: calc(100vh - 140px);">
            <!-- é€šçŸ¥åˆ—è¡¨ -->
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="pt-16">
        <!-- æœç´¢åŒºåŸŸ -->
        <section class="bg-white py-8 shadow-sm">
            <div class="container mx-auto px-6">
                <div class="flex flex-col lg:flex-row gap-6 items-center">
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="æœç´¢åœè½¦åœºä½ç½®ã€åç§°æˆ–åœ°å€..." 
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                                ğŸ”
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="searchParkingLots()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            æœç´¢
                        </button>
                        <button onclick="toggleFilters()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors">
                            ç­›é€‰
                        </button>
                    </div>
                </div>
                
                <!-- ç­›é€‰æ¡ä»¶ -->
                <div id="filter-panel" class="mt-6 hidden">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">ç­›é€‰æ¡ä»¶</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ä»·æ ¼èŒƒå›´</label>
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option>å…¨éƒ¨ä»·æ ¼</option>
                                    <option>0-10å…ƒ/å°æ—¶</option>
                                    <option>10-20å…ƒ/å°æ—¶</option>
                                    <option>20-30å…ƒ/å°æ—¶</option>
                                    <option>30å…ƒä»¥ä¸Š/å°æ—¶</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è½¦ä½çŠ¶æ€</label>
                                <div class="flex gap-2">
                                    <button class="filter-button active px-3 py-2 rounded-lg border" data-status="all">å…¨éƒ¨</button>
                                    <button class="filter-button px-3 py-2 rounded-lg border" data-status="available">ç©ºé—²</button>
                                    <button class="filter-button px-3 py-2 rounded-lg border" data-status="busy">ç´§å¼ </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è·ç¦»èŒƒå›´</label>
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option>å…¨éƒ¨è·ç¦»</option>
                                    <option>1å…¬é‡Œå†…</option>
                                    <option>3å…¬é‡Œå†…</option>
                                    <option>5å…¬é‡Œå†…</option>
                                    <option>10å…¬é‡Œå†…</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ™ºèƒ½æ¨è -->
        <section class="py-8 bg-gradient-to-br from-blue-50 to-indigo-50">
            <div class="container mx-auto px-6">
                <div id="smart-recommendations">
                    <!-- æ™ºèƒ½æ¨èå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </section>

        <!-- åœ°å›¾å’Œåˆ—è¡¨åŒºåŸŸ -->
        <section class="py-8">
            <div class="container mx-auto px-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- åœ°å›¾åŒºåŸŸ -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold mb-4">åœè½¦åœºåœ°å›¾</h2>
                        <div id="map" class="map-container"></div>
                    </div>
                    
                    <!-- åœè½¦åœºåˆ—è¡¨ -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">åœè½¦åœºåˆ—è¡¨</h2>
                            <div class="flex gap-2">
                                <button onclick="switchView('list')" id="list-view-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">åˆ—è¡¨</button>
                                <button onclick="switchView('card')" id="card-view-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">å¡ç‰‡</button>
                            </div>
                        </div>
                        
                        <div id="parking-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- åœè½¦åœºé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ¨èåœè½¦åœº -->
        <section class="py-8 bg-gray-50">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center mb-8 gradient-text">æ¨èåœè½¦åœº</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="recommended-parking">
                    <!-- æ¨èåœè½¦åœºå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </section>

        <!-- æ™ºèƒ½æ¨èç®—æ³•å¯è§†åŒ–é¢æ¿ï¼ˆæ–°å¢ï¼‰ -->
        <section class="py-12 bg-white" id="algorithm-visualization">
            <div class="container mx-auto px-6">
                <div class="text-center mb-10">
                    <h2 class="text-4xl font-bold gradient-text mb-4">ğŸ¤– æ™ºèƒ½æ¨èç®—æ³•å¯è§†åŒ–</h2>
                    <p class="text-gray-600 text-lg max-w-3xl mx-auto">
                        å±•ç¤ºAIæ¨èç®—æ³•çš„å®Œæ•´è®¡ç®—è¿‡ç¨‹ï¼Œæ”¯æŒå®æ—¶è°ƒèŠ‚æƒé‡å‚æ•°ï¼Œäº†è§£æ¯ä¸ªåœè½¦åœºçš„æ¨èå¾—åˆ†æ˜¯å¦‚ä½•è®¡ç®—çš„
                    </p>
                </div>

                <!-- æƒé‡è°ƒèŠ‚å™¨ -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-8 mb-10 shadow-lg">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">ğŸšï¸ ç®—æ³•æƒé‡è°ƒèŠ‚å™¨</h3>
                    <p class="text-gray-600 mb-6">æ‹–åŠ¨æ»‘å—è°ƒæ•´å„ç»´åº¦æƒé‡ï¼ˆæ€»å’Œéœ€ç­‰äº1.0ï¼‰</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- è·ç¦»æƒé‡ -->
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <label class="font-semibold text-lg text-gray-800">ğŸ“ è·ç¦»æƒé‡</label>
                                <span id="distance-weight-value" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">0.4</span>
                            </div>
                            <input type="range" id="distance-weight" min="0" max="1" step="0.1" value="0.4"
                                   class="w-full h-3 bg-blue-100 rounded-lg appearance-none cursor-pointer slider">
                            <p class="text-sm text-gray-500 mt-2">è·ç¦»è¶Šè¿‘ï¼Œè¯„åˆ†è¶Šé«˜</p>
                        </div>

                        <!-- ä»·æ ¼æƒé‡ -->
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <label class="font-semibold text-lg text-gray-800">ğŸ’° ä»·æ ¼æƒé‡</label>
                                <span id="price-weight-value" class="bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold">0.3</span>
                            </div>
                            <input type="range" id="price-weight" min="0" max="1" step="0.1" value="0.3"
                                   class="w-full h-3 bg-green-100 rounded-lg appearance-none cursor-pointer slider">
                            <p class="text-sm text-gray-500 mt-2">ä»·æ ¼è¶Šä½ï¼Œè¯„åˆ†è¶Šé«˜</p>
                        </div>

                        <!-- å¯ç”¨ç‡æƒé‡ -->
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <label class="font-semibold text-lg text-gray-800">ğŸ…¿ï¸ ç©ºä½ç‡æƒé‡</label>
                                <span id="availability-weight-value" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-bold">0.3</span>
                            </div>
                            <input type="range" id="availability-weight" min="0" max="1" step="0.1" value="0.3"
                                   class="w-full h-3 bg-purple-100 rounded-lg appearance-none cursor-pointer slider">
                            <p class="text-sm text-gray-500 mt-2">ç©ºä½è¶Šå¤šï¼Œè¯„åˆ†è¶Šé«˜</p>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <div id="weights-warning" class="text-red-600 font-semibold hidden">
                            âš ï¸ æƒé‡æ€»å’Œå¿…é¡»ä¸º1.0ï¼ˆå½“å‰: <span id="weights-sum">0.0</span>ï¼‰
                        </div>
                        <button onclick="applyCustomWeights()" id="apply-weights-btn"
                                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 shadow-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
                                disabled>
                            âœ¨ åº”ç”¨è‡ªå®šä¹‰æƒé‡å¹¶é‡æ–°è®¡ç®—
                        </button>
                    </div>
                </div>

                <!-- ç®—æ³•è¿è¡Œè¿‡ç¨‹å±•ç¤º -->
                <div class="bg-gray-50 rounded-xl p-8 mb-10 shadow-lg">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">âš™ï¸ ç®—æ³•è®¡ç®—è¿‡ç¨‹</h3>
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <div id="algorithm-log" class="font-mono text-sm space-y-3 max-h-80 overflow-y-auto">
                            <div class="text-gray-500">ç­‰å¾…åŠ è½½æ•°æ®...</div>
                        </div>
                    </div>
                </div>

                <!-- é›·è¾¾å›¾å¯¹æ¯” -->
                <div class="bg-gray-50 rounded-xl p-8 mb-10 shadow-lg">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“Š å¤šåœè½¦åœºé›·è¾¾å›¾å¯¹æ¯”</h3>
                    <div class="mb-4">
                        <select id="parking-comparison-selector" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                onchange="updateRadarChart()">
                            <option value="">é€‰æ‹©è¦å¯¹æ¯”çš„åœè½¦åœºï¼ˆæœ€å¤š3ä¸ªï¼‰</option>
                        </select>
                    </div>
                    <div id="radar-chart" class="bg-white rounded-lg shadow-md" style="height: 400px;"></div>
                </div>

                <!-- ç›¸ä¼¼åº¦æ ‡ç­¾å±•ç¤º -->
                <div class="bg-gray-50 rounded-xl p-8 shadow-lg">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">ğŸ·ï¸ æ™ºèƒ½æ ‡ç­¾åˆ†æ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="similarity-tags">
                        <!-- æ ‡ç­¾å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- é¡µè„š -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-6 text-center">
            <p class="text-gray-300">&copy; 2025 æ™ºèƒ½åœè½¦ç®¡ç†ç³»ç»Ÿ. åŸºäºäººå·¥æ™ºèƒ½å’Œç‰©è”ç½‘æŠ€æœ¯çš„ç°ä»£åŒ–åœè½¦è§£å†³æ–¹æ¡ˆ.</p>
        </div>
    </footer>

    <!-- åœè½¦åœºè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="parking-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold" id="modal-title">åœè½¦åœºè¯¦æƒ…</h3>
                <button onclick="closeParkingDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script src="mockData.js"></script>
    <script src="main.js"></script>
    <script src="smart-functions.js"></script>
    <script src="task3-recommendation.js"></script>
    <script>
        // åœè½¦åœºæŸ¥è¯¢é¡µé¢ç‰¹å®šåŠŸèƒ½
        let map;
        let parkingData = [];
        let currentView = 'list';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            generateParkingData();

            // åˆå§‹åŒ–æ™ºèƒ½æ¨èç³»ç»Ÿ
            if (typeof initializeRecommendation === 'function') {
                initializeRecommendation();
            }

            // æ¯10ç§’æ›´æ–°ä»·æ ¼æ˜¾ç¤ºï¼ˆåŠ¨æ€å®šä»·ï¼‰
            setInterval(() => {
                if (typeof updateParkingListPrices === 'function') {
                    updateParkingListPrices();
                }
            }, 10000);

            displayParkingLots();
            displayRecommendedParking();
            initializeFilterButtons();
        });

        // åˆå§‹åŒ–åœ°å›¾ï¼ˆå¸¦ç¤ºä¾‹å›¾ç‰‡å ä½ç¬¦ï¼‰
        function initializeMap() {
            const mapContainer = document.getElementById('map');

            try {
                // å°è¯•åˆå§‹åŒ–Leafletåœ°å›¾
                if (typeof L !== 'undefined') {
                    // é‡æ–°å®šä½åˆ°æ²ˆé˜³å¸‚ä¸œåŒ—å¤§å­¦å—æ¹–æ ¡åŒºï¼ˆçº¬åº¦: 41.7677, ç»åº¦: 123.4294ï¼‰
                    map = L.map('map').setView([41.7677, 123.4294], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);

                    // æ·»åŠ ä¸œåŒ—å¤§å­¦å—æ¹–æ ¡åŒºå‘¨è¾¹çš„åœè½¦åœºæ ‡è®°
                    const parkingLocations = [
                        { lat: 41.7700, lng: 123.4306, name: 'æœºç”µå­¦é¦†åœè½¦åœº', status: 'available' },
                        { lat: 41.7670, lng: 123.4240, name: 'å»ºç­‘å­¦é¦†åœè½¦åœº', status: 'busy' },
                        { lat: 41.7750, lng: 123.4330, name: 'å¤§æˆæ•™å­¦æ¥¼åœè½¦åœº', status: 'available' },
                        { lat: 41.7650, lng: 123.4350, name: 'é€¸å¤«æ•™å­¦æ¥¼åœè½¦åœº', status: 'full' },
                        { lat: 41.7720, lng: 123.4230, name: 'é‡‡çŸ¿å­¦é¦†åœè½¦åœº', status: 'available' }
                    ];

                    parkingLocations.forEach(parking => {
                        const color = parking.status === 'available' ? 'green' :
                                     parking.status === 'busy' ? 'orange' : 'red';

                        L.marker([parking.lat, parking.lng])
                            .addTo(map)
                            .bindPopup(`<b>${parking.name}</b><br>çŠ¶æ€: ${parking.status}`)
                            .setIcon(L.divIcon({
                                className: `custom-marker ${color}`,
                                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                                iconSize: [20, 20]
                            }));
                    });
                } else {
                    // Leafletåº“æœªåŠ è½½ï¼Œæ˜¾ç¤ºç¤ºä¾‹å›¾ç‰‡
                    throw new Error('Leaflet library not loaded');
                }
            } catch (error) {
                // æ˜¾ç¤ºç¤ºä¾‹åœ°å›¾å›¾ç‰‡
                console.log('Leafletåœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºç¤ºä¾‹å›¾ç‰‡:', error);
                mapContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full bg-gray-100 rounded-lg relative overflow-hidden">
                        <img src="https://picsum.photos/seed/parking-map/800/500.jpg" alt="åœè½¦åœºåœ°å›¾ç¤ºä¾‹" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                            <div class="text-white text-center">
                                <div class="text-4xl mb-2">ğŸ—ºï¸</div>
                                <div class="text-lg font-semibold">åœ°å›¾åŠ è½½ä¸­...</div>
                                <div class="text-sm opacity-80">ç¤ºä¾‹åœè½¦åœºåˆ†å¸ƒå›¾</div>
                                <div class="mt-4 text-xs opacity-60">
                                    æç¤ºï¼šè¿æ¥åˆ°äº’è”ç½‘ä»¥åŠ è½½å®æ—¶åœ°å›¾
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-3">
                        <div class="text-sm font-semibold mb-2">åœè½¦åœºçŠ¶æ€</div>
                        <div class="space-y-1 text-xs">
                            <div class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>ç©ºé—²: 4ä¸ª</div>
                            <div class="flex items-center"><div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>ç´§å¼ : 2ä¸ª</div>
                            <div class="flex items-center"><div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>å·²æ»¡: 1ä¸ª</div>
                        </div>
                    </div>
                `;
            }
        }

        // ç”Ÿæˆåœè½¦åœºæ•°æ®
        function generateParkingData() {
            const names = [
                'æœºç”µå­¦é¦†åœè½¦åœº', 'å»ºç­‘å­¦é¦†åœè½¦åœº', 'å¤§æˆåœè½¦åœº', 'é€¸å¤«åœè½¦åœº',
                'ä½•ä¸–ç¤¼åœè½¦åœº', 'é‡‡çŸ¿å­¦é¦†åœè½¦åœº', 'å†¶é‡‘å­¦é¦†åœè½¦åœº'
            ];

            const statuses = ['available', 'busy', 'full'];
            const prices = [5, 8, 10, 12, 15, 18, 20];

            parkingData = names.map((name, index) => {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const totalSpots = Math.floor(Math.random() * 200) + 50;
                const availableSpots = status === 'full' ? 0 :
                                     status === 'busy' ? Math.floor(totalSpots * 0.2) :
                                     Math.floor(totalSpots * 0.6);

                return {
                    id: index + 1,
                    name: name,
                    address: `æ²ˆé˜³å¸‚${name.split('åœè½¦åœº')[0]}`,
                    status: status,
                    totalSpots: totalSpots,
                    availableSpots: availableSpots,
                    price: prices[Math.floor(Math.random() * prices.length)],
                    distance: (Math.random() * 10 + 0.5).toFixed(1),
                    rating: (Math.random() * 2 + 3).toFixed(1),
                    image: `https://picsum.photos/seed/${index}/400/300.jpg`
                };
            });
        }

        // åˆ›å»ºåˆ—è¡¨è§†å›¾å…ƒç´ ï¼ˆç´§å‡‘å‹ï¼‰
        function createListParkingElement(parking) {
            const div = document.createElement('div');
            div.className = 'parking-card bg-gray-50 rounded-lg p-4 cursor-pointer border border-gray-200';
            div.setAttribute('data-lot-id', `P${String(parking.id).padStart(3, '0')}`);
            div.onclick = () => showParkingDetail(parking);

            const statusClass = parking.status === 'available' ? 'status-available' :
                               parking.status === 'busy' ? 'status-busy' : 'status-full';
            const statusText = parking.status === 'available' ? 'ç©ºé—²' :
                              parking.status === 'busy' ? 'ç´§å¼ ' : 'å·²æ»¡';

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="font-semibold text-lg flex-1">${parking.name}</h3>
                    <span class="${statusClass} font-medium text-sm ml-2">${statusText}</span>
                </div>
                <div class="text-sm text-gray-600 mb-2">${parking.address}</div>
                <div class="flex justify-between items-center text-sm mb-3">
                    <span class="flex items-center">
                        <span class="text-yellow-500 mr-1">â­</span>
                        ${parking.rating}
                    </span>
                    <span>ğŸ“ ${parking.distance}km</span>
                    <span class="dynamic-price">
                        <strong>ğŸ’° ${parking.price}å…ƒ/å°æ—¶</strong>
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm">ğŸ…¿ï¸ ${parking.availableSpots}/${parking.totalSpots} å¯ç”¨</span>
                    <button onclick="event.stopPropagation(); bookParkingSpot(${parking.id})"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        é¢„çº¦
                    </button>
                </div>
            `;

            return div;
        }

        // åˆ›å»ºå¡ç‰‡è§†å›¾å…ƒç´ ï¼ˆå«å›¾ç‰‡ï¼Œæ›´è¯¦ç»†ï¼‰
        function createCardParkingElement(parking) {
            const div = document.createElement('div');
            div.className = 'parking-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-all border border-gray-200';
            div.setAttribute('data-lot-id', `P${String(parking.id).padStart(3, '0')}`);
            div.onclick = () => showParkingDetail(parking);

            const statusClass = parking.status === 'available' ? 'status-available' :
                               parking.status === 'busy' ? 'status-busy' : 'status-full';
            const statusText = parking.status === 'available' ? 'ç©ºé—²' :
                              parking.status === 'busy' ? 'ç´§å¼ ' : 'å·²æ»¡';

            div.innerHTML = `
                <img src="${parking.image}" alt="${parking.name}" class="w-full h-48 object-cover">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-lg flex-1">${parking.name}</h3>
                        <span class="${statusClass} font-medium text-sm ml-2">${statusText}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">${parking.address}</div>
                    <div class="flex justify-between items-center text-sm mb-4">
                        <span class="flex items-center">
                            <span class="text-yellow-500 mr-1">â­</span>
                            ${parking.rating}
                        </span>
                        <span>ğŸ“ ${parking.distance}km</span>
                        <span class="dynamic-price font-bold">
                            ğŸ’° ${parking.price}å…ƒ/å°æ—¶
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm">
                            <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
                                ğŸ…¿ï¸ ${parking.availableSpots}/${parking.totalSpots}
                            </span>
                        </div>
                        <button onclick="event.stopPropagation(); bookParkingSpot(${parking.id})"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            ç«‹å³é¢„çº¦
                        </button>
                    </div>
                </div>
            `;

            return div;
        }

        // æ˜¾ç¤ºåœè½¦åœºåˆ—è¡¨ï¼ˆæ”¯æŒåˆ—è¡¨å’Œå¡ç‰‡è§†å›¾ï¼‰
        function displayParkingLots() {
            const container = document.getElementById('parking-list');
            if (!container) return;

            container.innerHTML = '';

            // æ ¹æ®ä¸åŒè§†å›¾è®¾ç½®ä¸åŒçš„å®¹å™¨æ ·å¼
            if (currentView === 'list') {
                container.className = 'space-y-4 max-h-96 overflow-y-auto';
            } else {
                container.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 max-h-96 overflow-y-auto';
            }

            parkingData.forEach(parking => {
                const parkingElement = currentView === 'list'
                    ? createListParkingElement(parking)
                    : createCardParkingElement(parking);
                container.appendChild(parkingElement);
            });
        }

        // è®¡ç®—åœè½¦åœºæ¨èæŒ‡æ•°ï¼ˆåŸºäºå¤šç»´ç‰¹å¾è¯„åˆ†æ¨¡å‹ï¼‰
        /**
         * è®¡ç®—åœè½¦åœºæ¨èæŒ‡æ•°ï¼ˆåŸºäºå¤šç»´ç‰¹å¾è¯„åˆ†æ¨¡å‹ï¼‰
         * @param {Object} parking - åœè½¦åœºå¯¹è±¡
         * @param {Object} weights - æƒé‡é…ç½® {distance, price, availability}
         * @param {String} parkingName - åœè½¦åœºåç§°ï¼ˆç”¨äºæ—¥å¿—æ˜¾ç¤ºï¼‰
         * @returns {Object} - åŒ…å«scoreã€reasonsã€detailså’Œlogçš„å¯¹è±¡
         */
        function calculateParkingScore(parking, weights = { distance: 0.4, price: 0.3, availability: 0.3 }, parkingName = '') {
            // åˆå§‹åŒ–æ—¥å¿—æ•°ç»„
            const log = [];
            if (parkingName) {
                log.push(`========== è®¡ç®—åœè½¦åœº: ${parkingName} ==========`);
            }
            log.push(`ğŸ“Š æƒé‡é…ç½®: distance=${(weights.distance*100).toFixed(0)}%, price=${(weights.price*100).toFixed(0)}%, availability=${(weights.availability*100).toFixed(0)}%`);

            // ===== è·ç¦»å¾—åˆ†è®¡ç®— =====
            log.push('ğŸ“ STEP 1: è®¡ç®—è·ç¦»å¾—åˆ†');
            log.push(`   åŸå§‹è·ç¦»: ${parking.distance}km`);
            const distanceScore = Math.max(0, 5 - parseFloat(parking.distance)) * 20; // 0-100åˆ†
            log.push(`   è®¡ç®—å…¬å¼: max(0, 5 - ${parking.distance}) Ã— 20 = ${distanceScore.toFixed(1)}åˆ†`);
            log.push(`   è¯„åˆ†æ ‡å‡†: 5kmä»¥å†…å¾—åˆ†ï¼Œ<1km=100åˆ†, <3km=60åˆ†, <5km=20åˆ†`);

            // ===== ä»·æ ¼å¾—åˆ†è®¡ç®— =====
            log.push('ğŸ’° STEP 2: è®¡ç®—ä»·æ ¼å¾—åˆ†');
            log.push(`   åŸå§‹ä»·æ ¼: ${parking.price}å…ƒ/å°æ—¶`);
            const priceScore = Math.max(0, 20 - parking.price) * 5; // 0-100åˆ†
            log.push(`   è®¡ç®—å…¬å¼: max(0, 20 - ${parking.price}) Ã— 5 = ${priceScore.toFixed(1)}åˆ†`);
            log.push(`   è¯„åˆ†æ ‡å‡†: 20å…ƒä»¥å†…å¾—åˆ†ï¼Œ<5å…ƒ=100åˆ†, <10å…ƒ=75åˆ†, <15å…ƒ=50åˆ†`);

            // ===== ç©ºä½ç‡å¾—åˆ†è®¡ç®— =====
            log.push('ğŸ…¿ï¸ STEP 3: è®¡ç®—ç©ºä½ç‡å¾—åˆ†');
            log.push(`   å¯ç”¨/æ€»è½¦ä½: ${parking.availableSpots}/${parking.totalSpots}`);
            const availabilityRatio = parking.availableSpots / parking.totalSpots;
            const availabilityScore = availabilityRatio * 100; // 0-100åˆ†
            log.push(`   ç©ºä½ç‡: ${(availabilityRatio*100).toFixed(1)}%`);
            log.push(`   è®¡ç®—å…¬å¼: ${(availabilityRatio*100).toFixed(1)} Ã— 1 = ${availabilityScore.toFixed(1)}åˆ†`);

            // ===== åŠ æƒç»¼åˆå¾—åˆ† =====
            log.push('âš–ï¸ STEP 4: åŠ æƒç»¼åˆè®¡ç®—');
            const weightedDistance = distanceScore * weights.distance;
            const weightedPrice = priceScore * weights.price;
            const weightedAvailability = availabilityScore * weights.availability;

            log.push(`   è·ç¦»åŠ æƒ: ${distanceScore.toFixed(1)} Ã— ${weights.distance} = ${weightedDistance.toFixed(1)}`);
            log.push(`   ä»·æ ¼åŠ æƒ: ${priceScore.toFixed(1)} Ã— ${weights.price} = ${weightedPrice.toFixed(1)}`);
            log.push(`   ç©ºä½ç‡åŠ æƒ: ${availabilityScore.toFixed(1)} Ã— ${weights.availability} = ${weightedAvailability.toFixed(1)}`);

            const finalScore = weightedDistance + weightedPrice + weightedAvailability;
            log.push(`   æœ€ç»ˆå¾—åˆ†: ${weightedDistance.toFixed(1)} + ${weightedPrice.toFixed(1)} + ${weightedAvailability.toFixed(1)} = ${finalScore.toFixed(1)}åˆ†`);

            // ===== ç”Ÿæˆæ¨èç†ç”± =====
            const reasons = [];
            if (distanceScore > 60) {
                reasons.push('è·ç¦»è¿‘');
                log.push('âœ… æ»¡è¶³æ¨èç†ç”±: è·ç¦»è¿‘');
            }
            if (priceScore > 60) {
                reasons.push('ä»·æ ¼ä½');
                log.push('âœ… æ»¡è¶³æ¨èç†ç”±: ä»·æ ¼ä½');
            }
            if (availabilityScore > 60) {
                reasons.push('ç©ºä½å¤š');
                log.push('âœ… æ»¡è¶³æ¨èç†ç”±: ç©ºä½å¤š');
            }
            if (reasons.length === 0) {
                log.push('â„¹ï¸ æ— çªå‡ºæ¨èç†ç”±');
            }

            log.push(`========== æœ€ç»ˆç»“æœ: ${Math.round(finalScore)}åˆ† ==========\n`);

            return {
                score: Math.round(finalScore),
                reasons: reasons,
                details: {
                    distance: Math.round(distanceScore),
                    price: Math.round(priceScore),
                    availability: Math.round(availabilityScore),
                    weightedDistance: weightedDistance,
                    weightedPrice: weightedPrice,
                    weightedAvailability: weightedAvailability
                },
                log: log
            };
        }

        // æ˜¾ç¤ºæ™ºèƒ½æ¨èåœè½¦åœº
        function displayRecommendedParking() {
            const container = document.getElementById('recommended-parking');
            if (!container) return;

            // åŠ è½½æƒé‡é…ç½®ï¼ˆå¯ä»ç®¡ç†å‘˜é…ç½®ï¼‰
            const weights = JSON.parse(localStorage.getItem('smartparking_recommend_weights') || '{"distance":0.4,"price":0.3,"availability":0.3}');

            // ä¸ºæ¯ä¸ªåœè½¦åœºè®¡ç®—è¯„åˆ†
            const parkingWithScores = parkingData.map(parking => {
                const scoreData = calculateParkingScore(parking, weights);
                return {
                    ...parking,
                    recommendationScore: scoreData.score,
                    recommendationReasons: scoreData.reasons,
                    scoreDetails: scoreData.details
                };
            });

            // æŒ‰æ¨èåˆ†æ•°æ’åºï¼Œå–å‰6ä¸ª
            const recommended = parkingWithScores
                .sort((a, b) => b.recommendationScore - a.recommendationScore)
                .slice(0, 6);

            container.innerHTML = '';

            recommended.forEach(parking => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-all cursor-pointer relative';
                div.onclick = () => showParkingDetail(parking);

                const statusClass = parking.status === 'available' ? 'status-available' :
                                   parking.status === 'busy' ? 'status-busy' : 'status-full';
                const statusText = parking.status === 'available' ? 'ç©ºé—²' :
                                  parking.status === 'busy' ? 'ç´§å¼ ' : 'å·²æ»¡';

                // æ¨èæŒ‡æ•°å¾½ç« 
                const scoreBadgeColor = parking.recommendationScore >= 80 ? 'green' :
                                       parking.recommendationScore >= 60 ? 'blue' : 'yellow';

                div.innerHTML = `
                    <div class="absolute top-4 right-4 z-10">
                        <div class="bg-${scoreBadgeColor}-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                            æ¨èæŒ‡æ•° ${parking.recommendationScore}%
                        </div>
                    </div>
                    <img src="${parking.image}" alt="${parking.name}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-lg">${parking.name}</h3>
                            <span class="${statusClass} font-medium text-sm">${statusText}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-3">${parking.address}</div>

                        <!-- æ¨èç†ç”± -->
                        ${parking.recommendationReasons.length > 0 ? `
                            <div class="mb-3">
                                <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">
                                    æ¨èç†ç”±ï¼š${parking.recommendationReasons.join('ã€')}
                                </span>
                            </div>
                        ` : ''}

                        <div class="flex justify-between items-center text-sm mb-3">
                            <span>ğŸ’° ${parking.price}å…ƒ/å°æ—¶</span>
                            <span>ğŸ“ ${parking.distance}km</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="text-yellow-500">â­</span>
                                <span class="ml-1 text-sm">${parking.rating}</span>
                            </div>
                            <button onclick="event.stopPropagation(); bookParkingSpot(${parking.id})"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                ç«‹å³é¢„çº¦
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(div);
            });
        }

        // åˆ‡æ¢ç­›é€‰é¢æ¿
        function toggleFilters() {
            const panel = document.getElementById('filter-panel');
            if (panel) {
                panel.classList.toggle('hidden');
            }
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            currentView = view;
            const listBtn = document.getElementById('list-view-btn');
            const cardBtn = document.getElementById('card-view-btn');
            
            if (view === 'list') {
                listBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg';
                cardBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg';
            } else {
                listBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg';
                cardBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg';
            }
            
            displayParkingLots();
        }

        // åˆå§‹åŒ–ç­›é€‰æŒ‰é’®
        function initializeFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-button');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const status = this.dataset.status;
                    filterParkingLots(status);
                });
            });
        }

        // ç­›é€‰åœè½¦åœº
        function filterParkingLots(status) {
            let filteredData = parkingData;
            
            if (status !== 'all') {
                filteredData = parkingData.filter(parking => parking.status === status);
            }
            
            const container = document.getElementById('parking-list');
            if (!container) return;

            container.innerHTML = '';

            filteredData.forEach(parking => {
                const parkingElement = createParkingElement(parking);
                container.appendChild(parkingElement);
            });
        }

        // æ˜¾ç¤ºåœè½¦åœºè¯¦æƒ…
        function showParkingDetail(parking) {
            const modal = document.getElementById('parking-detail-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            if (modal && title && content) {
                title.textContent = parking.name;
                
                const statusClass = parking.status === 'available' ? 'status-available' :
                                   parking.status === 'busy' ? 'status-busy' : 'status-full';
                const statusText = parking.status === 'available' ? 'ç©ºé—²' :
                                  parking.status === 'busy' ? 'ç´§å¼ ' : 'å·²æ»¡';
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img src="${parking.image}" alt="${parking.name}" class="w-full h-48 object-cover rounded-lg">
                        </div>
                        <div>
                            <div class="mb-4">
                                <h4 class="font-semibold mb-2">åŸºæœ¬ä¿¡æ¯</h4>
                                <p class="text-sm text-gray-600 mb-1">åœ°å€: ${parking.address}</p>
                                <p class="text-sm text-gray-600 mb-1">çŠ¶æ€: <span class="${statusClass}">${statusText}</span></p>
                                <p class="text-sm text-gray-600 mb-1">ä»·æ ¼: ${parking.price}å…ƒ/å°æ—¶</p>
                                <p class="text-sm text-gray-600 mb-1">è·ç¦»: ${parking.distance}km</p>
                                <p class="text-sm text-gray-600">è¯„åˆ†: ${parking.rating} â­</p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold mb-2">è½¦ä½ä¿¡æ¯</h4>
                                <p class="text-sm text-gray-600">æ€»è½¦ä½æ•°: ${parking.totalSpots}</p>
                                <p class="text-sm text-gray-600">ç©ºé—²è½¦ä½: ${parking.availableSpots}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${(parking.availableSpots / parking.totalSpots) * 100}%"></div>
                                </div>
                            </div>
                            <button onclick="bookParkingSpot(${parking.id})" 
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                ç«‹å³é¢„çº¦è½¦ä½
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            }
        }

        // å…³é—­åœè½¦åœºè¯¦æƒ…
        function closeParkingDetail() {
            const modal = document.getElementById('parking-detail-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // é¢„çº¦åœè½¦åœº
        function bookParkingSpot(parkingId) {
            console.log('é¢„çº¦åœè½¦åœºID:', parkingId);
            // è·³è½¬åˆ°é¢„çº¦é¡µé¢
            window.location.href = `booking.html?parkingId=${parkingId}`;
        }

        // ==========================================
        // PHASE 1: æ™ºèƒ½æ¨èç®—æ³•å¯è§†åŒ–åŠŸèƒ½
        // ==========================================

        let radarChart = null;
        let selectedParkingForComparison = [];

        /**
         * æ›´æ–°æƒé‡æ˜¾ç¤ºå€¼
         */
        function updateWeightDisplays() {
            const distanceWeight = parseFloat(document.getElementById('distance-weight').value);
            const priceWeight = parseFloat(document.getElementById('price-weight').value);
            const availabilityWeight = parseFloat(document.getElementById('availability-weight').value);

            document.getElementById('distance-weight-value').textContent = distanceWeight.toFixed(1);
            document.getElementById('price-weight-value').textContent = priceWeight.toFixed(1);
            document.getElementById('availability-weight-value').textContent = availabilityWeight.toFixed(1);

            // è®¡ç®—æ€»å’Œ
            const sum = distanceWeight + priceWeight + availabilityWeight;
            document.getElementById('weights-sum').textContent = sum.toFixed(1);

            // æ˜¾ç¤º/éšè—è­¦å‘Š
            const warningDiv = document.getElementById('weights-warning');
            const applyBtn = document.getElementById('apply-weights-btn');

            if (Math.abs(sum - 1.0) > 0.01) {
                warningDiv.classList.remove('hidden');
                applyBtn.disabled = true;
            } else {
                warningDiv.classList.add('hidden');
                applyBtn.disabled = false;
            }
        }

        /**
         * ç»‘å®šæƒé‡æ»‘å—äº‹ä»¶
         */
        function bindWeightSliders() {
            const sliders = ['distance-weight', 'price-weight', 'availability-weight'];

            sliders.forEach(sliderId => {
                const slider = document.getElementById(sliderId);
                if (slider) {
                    slider.addEventListener('input', function() {
                        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        anime({
                            targets: `#${sliderId}`,
                            scale: [1, 1.05, 1],
                            duration: 200,
                            easing: 'easeInOutQuad'
                        });
                        updateWeightDisplays();
                    });
                }
            });

            // åˆå§‹åŒ–æ˜¾ç¤º
            updateWeightDisplays();
        }

        /**
         * åº”ç”¨è‡ªå®šä¹‰æƒé‡å¹¶é‡æ–°è®¡ç®—
         */
        function applyCustomWeights() {
            const weights = {
                distance: parseFloat(document.getElementById('distance-weight').value),
                price: parseFloat(document.getElementById('price-weight').value),
                availability: parseFloat(document.getElementById('availability-weight').value)
            };

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('smartparking_recommend_weights', JSON.stringify(weights));

            // é‡æ–°è®¡ç®—æ¨è
            displayRecommendedParking();

            // é‡æ–°ç”Ÿæˆç®—æ³•æ—¥å¿—
            generateAlgorithmLog();

            // é‡æ–°ç”Ÿæˆé›·è¾¾å›¾
            if (selectedParkingForComparison.length > 0) {
                updateRadarChart();
            }

            // æˆåŠŸæç¤º
            alert('âœ… æƒé‡å·²æ›´æ–°ï¼æ¨èç»“æœå·²é‡æ–°è®¡ç®—ã€‚');
        }

        /**
         * ç”Ÿæˆç®—æ³•è¿ç®—è¿‡ç¨‹æ—¥å¿—
         */
        function generateAlgorithmLog() {
            const logContainer = document.getElementById('algorithm-log');
            if (!logContainer || !parkingData || parkingData.length === 0) {
                logContainer.innerHTML = '<div class="text-gray-500">ç­‰å¾…åŠ è½½æ•°æ®...</div>';
                return;
            }

            // åŠ è½½æƒé‡é…ç½®
            const weights = JSON.parse(localStorage.getItem('smartparking_recommend_weights') || '{"distance":0.4,"price":0.3,"availability":0.3}');

            logContainer.innerHTML = '';

            // é€‰æ‹©å‰3ä¸ªåœè½¦åœºå±•ç¤ºè¯¦ç»†è®¡ç®—è¿‡ç¨‹
            const sampleParkings = parkingData.slice(0, 3);

            sampleParkings.forEach((parking, index) => {
                const result = calculateParkingScore(parking, weights, parking.name);

                // åˆ›å»ºæ—¥å¿—å…ƒç´ 
                const logDiv = document.createElement('div');
                logDiv.className = 'bg-gray-50 rounded p-4 mb-4';

                const logContent = result.log.map(line => {
                    let color = 'text-gray-700';
                    if (line.includes('==========')) color = 'text-blue-600 font-bold';
                    if (line.includes('STEP')) color = 'text-purple-600 font-semibold';
                    if (line.includes('âœ…')) color = 'text-green-600';
                    if (line.includes('â„¹ï¸')) color = 'text-gray-500';

                    return `<div class="${color}">${line}</div>`;
                }).join('');

                logDiv.innerHTML = logContent;
                logContainer.appendChild(logDiv);

                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                anime({
                    targets: logDiv,
                    opacity: [0, 1],
                    translateY: [20, 0],
                    delay: index * 200,
                    duration: 500,
                    easing: 'easeOutQuad'
                });
            });

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            logContainer.scrollTop = 0;
        }

        /**
         * åˆå§‹åŒ–é›·è¾¾å›¾
         */
        function initializeRadarChart() {
            const chartContainer = document.getElementById('radar-chart');
            if (!chartContainer) return;

            // åˆå§‹åŒ–ECharts
            radarChart = echarts.init(chartContainer);

            // è®¾ç½®åˆå§‹ç©ºå›¾è¡¨
            const option = {
                title: {
                    text: 'é€‰æ‹©åœè½¦åœºè¿›è¡Œå¯¹æ¯”',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#666',
                        fontSize: 16
                    }
                },
                radar: {
                    indicator: [
                        { name: 'è·ç¦»å¾—åˆ†', max: 100 },
                        { name: 'ä»·æ ¼å¾—åˆ†', max: 100 },
                        { name: 'ç©ºä½ç‡å¾—åˆ†', max: 100 },
                        { name: 'ç»¼åˆå¾—åˆ†', max: 100 }
                    ],
                    shape: 'polygon',
                    splitNumber: 5,
                    axisName: {
                        color: '#666'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#ddd'
                        }
                    },
                    splitArea: {
                        show: true,
                        areaStyle: {
                            color: ['rgba(59, 130, 246, 0.1)', 'rgba(59, 130, 246, 0.05)']
                        }
                    }
                },
                series: [{
                    name: 'åœè½¦åœºè¯„åˆ†å¯¹æ¯”',
                    type: 'radar',
                    data: []
                }],
                legend: {
                    bottom: 20
                },
                tooltip: {
                    trigger: 'item'
                }
            };

            radarChart.setOption(option);

            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', () => {
                if (radarChart) {
                    radarChart.resize();
                }
            });
        }

        /**
         * æ›´æ–°é›·è¾¾å›¾ï¼ˆä¿®å¤ç‰ˆï¼‰
         */
        function updateRadarChart() {
            if (!radarChart) {
                console.error('é›·è¾¾å›¾æœªåˆå§‹åŒ–');
                return;
            }

            const selector = document.getElementById('parking-comparison-selector');
            if (!selector) {
                console.error('é€‰æ‹©å™¨æœªæ‰¾åˆ°');
                return;
            }

            const selectedValue = selector.value;
            if (!selectedValue) {
                console.log('æœªé€‰æ‹©åœè½¦åœº');
                return;
            }

            if (!parkingData || parkingData.length === 0) {
                console.error('åœè½¦åœºæ•°æ®æœªåŠ è½½');
                return;
            }

            const selectedParking = parkingData.find(p => p.id == selectedValue);
            if (!selectedParking) {
                console.error('æœªæ‰¾åˆ°é€‰æ‹©çš„åœè½¦åœº');
                return;
            }

            // æ·»åŠ åˆ°å¯¹æ¯”åˆ—è¡¨ï¼ˆé™åˆ¶3ä¸ªï¼‰
            if (!selectedParkingForComparison.find(p => p.id == selectedValue)) {
                selectedParkingForComparison.push(selectedParking);
                if (selectedParkingForComparison.length > 3) {
                    selectedParkingForComparison.shift(); // ç§»é™¤æœ€æ—©çš„ä¸€ä¸ª
                }
            }

            // åŠ è½½æƒé‡é…ç½®
            const weights = JSON.parse(localStorage.getItem('smartparking_recommend_weights') || '{"distance":0.4,"price":0.3,"availability":0.3}');

            // å‡†å¤‡é›·è¾¾å›¾æ•°æ®
            const radarData = selectedParkingForComparison.map((parking, index) => {
                const result = calculateParkingScore(parking, weights);

                // æ•°æ®éªŒè¯
                if (!result || !result.details) {
                    console.error('è®¡ç®—ç»“æœæ— æ•ˆ', result);
                    return null;
                }

                const colors = ['#3b82f6', '#10b981', '#f59e0b'];
                return {
                    value: [
                        result.details.distance || 0,
                        result.details.price || 0,
                        result.details.availability || 0,
                        result.score || 0
                    ],
                    name: parking.name,
                    itemStyle: {
                        color: colors[index % colors.length]
                    },
                    lineStyle: {
                        color: colors[index % colors.length]
                    }
                };
            }).filter(item => item !== null);

            if (radarData.length === 0) {
                console.error('æ²¡æœ‰æœ‰æ•ˆçš„é›·è¾¾å›¾æ•°æ®');
                return;
            }

            const option = {
                title: {
                    text: 'åœè½¦åœºå¤šç»´åº¦è¯„åˆ†å¯¹æ¯”',
                    left: 'center'
                },
                radar: {
                    indicator: [
                        { name: 'è·ç¦»å¾—åˆ†', max: 100 },
                        { name: 'ä»·æ ¼å¾—åˆ†', max: 100 },
                        { name: 'ç©ºä½ç‡å¾—åˆ†', max: 100 },
                        { name: 'ç»¼åˆå¾—åˆ†', max: 100 }
                    ]
                },
                series: [{
                    name: 'åœè½¦åœºè¯„åˆ†',
                    type: 'radar',
                    data: radarData
                }],
                legend: {
                    data: selectedParkingForComparison.map(p => p.name),
                    bottom: 20
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `<strong>${params.name}</strong><br/>
                                è·ç¦»å¾—åˆ†: ${params.value[0]}<br/>
                                ä»·æ ¼å¾—åˆ†: ${params.value[1]}<br/>
                                ç©ºä½ç‡å¾—åˆ†: ${params.value[2]}<br/>
                                ç»¼åˆå¾—åˆ†: ${params.value[3]}`;
                    }
                }
            };

            radarChart.setOption(option);
            console.log('é›·è¾¾å›¾å·²æ›´æ–°', radarData);
        }

        /**
         * åˆå§‹åŒ–å¯¹æ¯”é€‰æ‹©å™¨
         */
        function initializeComparisonSelector() {
            const selector = document.getElementById('parking-comparison-selector');
            if (!selector) return;

            // æ¸…ç©ºå¹¶æ·»åŠ é»˜è®¤é€‰é¡¹
            selector.innerHTML = '<option value="">é€‰æ‹©è¦å¯¹æ¯”çš„åœè½¦åœºï¼ˆæœ€å¤š3ä¸ªï¼‰</option>';

            // æ·»åŠ åœè½¦åœºé€‰é¡¹
            parkingData.forEach(parking => {
                const option = document.createElement('option');
                option.value = parking.id;
                option.textContent = parking.name;
                selector.appendChild(option);
            });
        }

        /**
         * ç”Ÿæˆç›¸ä¼¼åº¦æ ‡ç­¾
         */
        function generateSimilarityTags() {
            const container = document.getElementById('similarity-tags');
            if (!container || !parkingData || parkingData.length < 2) return;

            container.innerHTML = '';

            // è®¡ç®—æ‰€æœ‰åœè½¦åœºå¯¹ä¹‹é—´çš„ç›¸ä¼¼åº¦
            const similarities = [];
            for (let i = 0; i < Math.min(parkingData.length, 5); i++) {
                for (let j = i + 1; j < Math.min(parkingData.length, 5); j++) {
                    const similarity = calculateSimilarity(parkingData[i], parkingData[j]);
                    similarities.push({
                        parkingA: parkingData[i],
                        parkingB: parkingData[j],
                        similarity: similarity
                    });
                }
            }

            // æ’åºå¹¶å–æœ€ç›¸ä¼¼çš„3å¯¹
            similarities.sort((a, b) => b.similarity - a.similarity);
            const topSimilarities = similarities.slice(0, 3);

            // ç”Ÿæˆæ ‡ç­¾å¡ç‰‡
            topSimilarities.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg p-6 shadow-md transform hover:scale-105 transition-all';

                const similarityPercent = (item.similarity * 100).toFixed(0);
                const badgeColor = item.similarity > 0.8 ? 'green' : item.similarity > 0.6 ? 'blue' : 'yellow';

                card.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="bg-${badgeColor}-100 text-${badgeColor}-800 px-3 py-1 rounded-full font-bold inline-block">
                            ${similarityPercent}% ç›¸ä¼¼
                        </div>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">${item.parkingA.name}</span>
                            <span class="text-gray-500">VS</span>
                            <span class="font-medium">${item.parkingB.name}</span>
                        </div>
                        <div class="border-t pt-3">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>è·ç¦»: ${item.parkingA.distance}km vs ${item.parkingB.distance}km</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>ä»·æ ¼: ${item.parkingA.price}å…ƒ vs ${item.parkingB.price}å…ƒ</span>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(card);

                // æ·»åŠ åŠ¨ç”»
                anime({
                    targets: card,
                    opacity: [0, 1],
                    translateY: [30, 0],
                    delay: index * 150,
                    duration: 600,
                    easing: 'easeOutQuad'
                });
            });
        }

        /**
         * è®¡ç®—ä¸¤ä¸ªåœè½¦åœºçš„ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
         * @param {Object} p1 - åœè½¦åœº1
         * @param {Object} p2 - åœè½¦åœº2
         * @returns {Number} - ç›¸ä¼¼åº¦ï¼ˆ0-1ï¼‰
         */
        function calculateSimilarity(p1, p2) {
            // ç‰¹å¾å‘é‡: [è·ç¦», ä»·æ ¼, ç©ºä½ç‡]
            const vec1 = [
                parseFloat(p1.distance) / 10, // å½’ä¸€åŒ–
                p1.price / 20,
                p1.availableSpots / p1.totalSpots
            ];

            const vec2 = [
                parseFloat(p2.distance) / 10,
                p2.price / 20,
                p2.availableSpots / p2.totalSpots
            ];

            // è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
            const dotProduct = vec1[0] * vec2[0] + vec1[1] * vec2[1] + vec1[2] * vec2[2];
            const magnitude1 = Math.sqrt(vec1[0] ** 2 + vec1[1] ** 2 + vec1[2] ** 2);
            const magnitude2 = Math.sqrt(vec2[0] ** 2 + vec2[1] ** 2 + vec2[2] ** 2);

            return magnitude1 === 0 || magnitude2 === 0 ? 0 : dotProduct / (magnitude1 * magnitude2);
        }

        /**
         * åˆå§‹åŒ–ç®—æ³•å¯è§†åŒ–é¢æ¿
         */
        function initializeAlgorithmVisualization() {
            if (!document.getElementById('algorithm-visualization')) return;

            // ç»‘å®šæƒé‡æ»‘å—
            bindWeightSliders();

            // åˆå§‹åŒ–é›·è¾¾å›¾
            setTimeout(() => {
                initializeRadarChart();
                initializeComparisonSelector();
            }, 500);

            // ç”Ÿæˆåˆå§‹æ—¥å¿—
            setTimeout(() => {
                generateAlgorithmLog();
            }, 1000);

            // ç”Ÿæˆç›¸ä¼¼åº¦æ ‡ç­¾
            setTimeout(() => {
                generateSimilarityTags();
            }, 1500);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç®—æ³•å¯è§†åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åŸæœ‰çš„åˆå§‹åŒ–ä»£ç ...

            // å»¶è¿Ÿåˆå§‹åŒ–ç®—æ³•å¯è§†åŒ–ï¼ˆç­‰å¾…æ•°æ®åŠ è½½å®Œæˆï¼‰
            setTimeout(() => {
                initializeAlgorithmVisualization();
            }, 2000);
        });
    </script>
</body>
</html>